#!/bin/bash

set -e

if [ -z $1 ]; then
  echo "Please set the 'version' variable"
  exit 1
fi

if [ -z $2 ]; then
  error "Please set the 'distribution_src' variable"
  exit 1
fi

VERSION="$1"
DISTRIBUTION_SRC="$2"

# the temp folder to store binary file...
mkdir -p binary
rm -rf binary/registry || true

cd `dirname $0`

# the temp folder to store distribution source code...
TEMP=`mktemp -d ${TMPDIR-/tmp}/distribution.XXXXXX`
git clone -b $VERSION --depth 1 $DISTRIBUTION_SRC $TEMP

# add patch redis
cd $TEMP
git apply ~-/redis.patch
cd -

echo 'build the registry binary ...'
DOCKER_BUILDKIT=1 docker build -f Dockerfile.binary -o binary/ $TEMP

echo "Build registry binary success, then to build photon image..."
cp $TEMP/cmd/registry/config-example.yml config.yml
rm -rf $TEMP
